Sub test22()

Call CheckFileDate
Call CheckAppNo

End Sub


Private Sub CheckFileDate()

'工作表"专利"中的第J列是专利申请日，判断前2000行（今后可以扩充），如果该列的第i行不是日期格式，那么将该单元格的颜色设置为灰色
'灰色的RGB值是RGB（96,96,96）


Set fileDateRng = Worksheets("专利").Range("J:J")

Dim i As Integer

For i = 3 To 1100 Step 1

    Call isDateType(fileDateRng.Cells(i, 1).Value)
    
    If dateTypeCheck = False Then
    
        fileDateRng.Cells(i, 1).Interior.Color = RGB(96, 96, 96)
        
    End If
    
Next i


End Sub


Private Sub isDateType(applicationDate)

'判断（J列）单元格中的数据类型是否为日期类型

    dateTypeCheck = False   '默认dateTypeCheck=false,防止误判

    If IsDate(applicationDate) Then

        dateTypeCheck = True
        
    Else: dateTypeCheck = False
    
    End If
    
End Sub
'*****************************************************
'*****************************************************

Private Function PatentAppNoCheckBit(applicationNumber)   '专利申请号校验位

    Dim LengthOfAppNumber As Byte
    Dim ArrAppNo()
    Dim sum, i As Integer
    
    i = 1
    sum = 0
    
    applicationNumber = Replace(Replace(applicationNumber, " ", ""), ".", "")  'delete ""  "/" in applicationNumber
    
    CheckBitSequence = Array(2, 3, 4, 5, 6, 7, 8, 9, 2, 3, 4, 5)
    
        LengthOfAppNumber = Len(applicationNumber) - 1 '形参aaplicationNumber是13位的专利号，最后一位是检验位，只需要取前12位
            
        ReDim ArrAppNo(1 To LengthOfAppNumber)
            
            For i = 1 To LengthOfAppNumber Step 1
            
                ArrAppNo(i) = CInt(Mid(applicationNumber, i, 1))
                sum = sum + ArrAppNo(i) * CheckBitSequence(i - 1)   'CheckBitSequence下标从0开始，for循环的i从1开始，故（i-1)
                
            Next i
            
        PatentAppNoCheckBit = sum Mod 11
        
End Function

Private Sub CheckAppNo()

On Error Resume Next        '此处的on error resume next是权宜之计，如果没有resume next，当K列的某个单元格的值为空时，会显示溢出错误
                            '今后可以考虑利用正则表达式设置K列（申请号）和J列（申请日）的输入规则
                            
Set appNoRng = Worksheets("专利").Range("K:K")
Dim checkBitValue As Byte
Dim farRightAppNo As Variant

For i = 3 To 1100 Step 1

    appNoRng.Cells(i, 1).Select     '选中当前要处理的单元格

    checkBitValue = PatentAppNoCheckBit(appNoRng.Cells(i, 1))           '进入function PatentAppNoCheckBit 计算检验位
    
    appNoRng.Cells(i, 1) = Replace(appNoRng.Cells(i, 1), " ", "")       '把单元格里面的空格去除
    
    farRightAppNo = Right(appNoRng.Cells(i, 1), 1)                      '提取单元格中的最后一位
    
    If farRightAppNo = "X" Then
    
        If checkBitValue < 10 Then
        
            appNoRng.Cells(i, 1).Interior.Color = RGB(96, 96, 96)
        
         End If
        
    Else
    
        farRightAppNo = CInt(farRightAppNo)
        
        If Not (farRightAppNo = checkBitValue) Then
        
            appNoRng.Cells(i, 1).Interior.Color = RGB(96, 96, 96)
            
        End If
    
    End If
    
    
Next i

End Sub
